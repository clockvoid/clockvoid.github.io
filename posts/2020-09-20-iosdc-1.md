---
title: iOSDC 2020 第1日目
github-link: posts/2020-09-20-iosdc-1.md
summary: iOSDC 一日目で気になったことと初めて知ったことをまとめます．
---

# 4年間運用する中で表示速度が落ちた画面を改善する中で得た知見
古い端末のほうが標示が顕著に遅くなってしまう

iPhone 8などを使用しても一秒以上かかってしまう

`init`から`viewDidAppear`までの時間を測定した

## 画面の構成
上から，

- VideoPlayerViewController
- DetailViewController
- VideoFullScreenViewController

となっている

VideoFullScreenViewControllerがまず初期化され，その中でVideoPlayerViewContollerを初期化するなどの処理を行う

はじめはDetailだけを表示するだけだったが，プレイヤとかも追加された

DetailViewは

- サムネイル
- Expandする詳細
- アクションのアイコン
- 縦方向のTableView
- 一番下にレコメンド

という感じで，StackViewで作られている

これ以外に横画面に対応するためのStackViewとかもいる

サムネイルはすぐに表示されるが，動画が初期化されたらプレイヤを表示する

## 表示を遅くした原因
Nibは一回生成されるとキャッシュされる

→殆どの場合で二回目以降は少し早い

よくあるNibの初期化が遅くなる原因

- フォントの参照が切れる
  - System Fontを使用していたため，ない

## 改善案
- Xibをやめてコードで作る
- Viewの初期化を遅延させる
  - こっちを採用

レコメンド

- はじめはHide
- 取得が終わったらレイアウト処理

Expand

- はじめはHide
- タップするとレイアウト処理

## 改善方法
一個一個Viewが初期化された後別のViewを初期化するみたいな遅延初期化をするようにした

ViewModelとObservableをつなぐクラスを作った

ViewModelが初期化完了したかどうかを知るObservableを作った

Viewの初期化が終了したときのObservableを作り，それが終わったらレコメンドのレイアウトを開始する

...ということをして高速化した

結果，半分くらいの表示速度になった

- StakViewのdidSetでarrangedSubViewしていたViewをviewDidAppear後に遅延初期化してそのタイミングでarrangedSubviewするように修正
- viewDidLoadでbindしていたObserver・ObservableをLazyRelaysのPublishRelayを経由するようにして遅延初期化に対応
- レコメンドの取得をViewのち円初期化後に変更（レコメンドの描画その後になる

## 画面の回転について
画面の回転時も時間がかかる

collectionViewの高さのConstraintに合わせてView自体の高さを決めるため，Cellは再利用されずに，すべて再描画され

縦横回転をするとStackViewのスタック方向が変わる→遅延初期化後に方向をチェックする

## 改善
StackViewだったところをCollectionViewに変更

CollectionViewで表示するときにLazyViewを再利用できるようにした
→差分更新を使って描画する

RxDataSourceを使ってサムネイルとかレコメンドセルとかをいい感じに流すようにした（？）

副次的な効果として，A/Bテストが簡単にできた

- UIScrollView + UIStackViewの構成からUICollectionViewに変更
- 各ViewからUIStackView + arrangedSubviewsの実装を別Viewに分離
- UIStackViewのarrangedSubViewのisHiddenによるレイアウト更新を差分更新ライブラリを用いたUICollectionViewのアニメーションに更新

## まとめ
- Xibは初回ロードに大幅に時間がかかる
- 画面の表示速度が遅くなった場合にViewの生成を遅延させると効果が出やすい．（bindした直後に処理がは閣下し，レイアウト処理が実行された事によって表示が遅延してしまっていた可能性もある）
- UICollectionView（またはUITableView）でデータソースの受け渡しを遅延させれば，Viewの生成を遅延させることもできる
- データソースを宣言的にすることで，モジュールの入れ替えや追加がかんたんになる

## Ask-the-speaker
- 最終的に表示するタイミングは変わらないが，ちゃんとプログレスバーが表示されて，ユーザがちゃんとロードしていることが理解できるようにしたというお話だった

- Nibを使わないという方法があったと思うが，あれはどうなのか？
  - 着手できなかったのでわからない
- ユーザに対する改善はあったのか
  - もともと数値が伸びていなかった→このスピードが問題なんじゃないかということで，改善
  - 結果，あまり関係はしていなかったが，事業として進められたのはとても良かった

# そろそろ始めるCombine

